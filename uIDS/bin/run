#!/usr/bin/env bash

if [ "$#" -lt 6 ]; then
  echo "usage: $0 binary entrypoint argv container-entrypoint container-argv mode server-start path-length [redirects]"
  exit 1
fi

PROGRAM=$1
ENTRYPOINT=$2
ARGV=$3
CONTAINER_ENTRYPOINT=$4
CONTAINER_ENTRYPOINT_ARGS=$5
MODE=$6
SERVER=$7
PATHLENGTH=$8
FILESYSTEM=$9

case $MODE in
promiscuous)
  MODELINE="--primus-promiscuous-mode --primus-greedy-scheduler"
  ;;
*)
  MODELINE="--primus-greedy-scheduler"
  ;;
esac

# Limit-max-length the total number of instructions Primus will run

# Useful options for tracing the execution of the Primus machine.
# --primus-print-obs=exception,pc-changed,jumping,call,call-return,machine-switch,machine-fork,lisp-message,incident,incident-location \
# --primus-print-output=primus.log \
# --cache-size=1024 \
# --primus-lisp-channel-redirect=/usr/local/nginx/logs/error.log:/tmp/uIDS/error.log \
# --primus-lisp-channel-redirect=/echo/echo.conf:/uIDS/images/echo/4/echo/echo.conf =
# --primus-promiscuous-mode \
# --primus-greedy-scheduler \
# --report-progress \

opam config exec -- bap $PROGRAM -prun \
  --run-entry-points="${ENTRYPOINT}" \
  --run-argv=${ARGV} \
  --primus-limit-max-length=${PATHLENGTH} \
  ${MODELINE} \
  --primus-uids-model \
  --primus-uids-inetd-startup \
  ${FILESYSTEM} \
  --primus-uids-server-start="${SERVER}" \
  --primus-uids-entrypoint="${CONTAINER_ENTRYPOINT}" \
  --primus-uids-entrypoint-args="${CONTAINER_ENTRYPOINT_ARGS}"
